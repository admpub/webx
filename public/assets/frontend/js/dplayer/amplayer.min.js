(function(e){var c={options:{autoPlay:true,autoSkip:true,autoNext:true,debug:false,live:false,trys:0,seek:0,take:"",urls:"",seq:"",jump:"",logo:"",pics:"",p2pAppId:"",p2pEngine:"",p2pConfig:{},srt2vttConvertApi:"",container:"",defaultType:"customHls",defaultExtName:".m3u8"},secure:window.location.protocol=="https:",elemPrefix:function(){return c.options.container?c.options.container+" ":""},player:{torrentAdd:function(e,t,n){n.notice(App.i18n.CONNECTED,5e3);var i=new RegExp("\\.(mp4)$","i");var o=e.files.find(function(e){console.log("[torrent] adding file: ",e.path||e.name);return i.test(e.name)});var r={autoplay:n.options.autoplay};if(e.urlList&&e.urlList.length>0){var a=new RegExp("poster\\.(jp[e]?g|png|gif|webp|svg)$","i");var l=e.files.find(function(e){return a.test(e.name)});if(l){l=e.urlList[0]+l.path;console.log("[torrent] adding cover: ",l);$(c.elemPrefix()+"video").attr("poster",l)}var p=new RegExp("\\.(vtt)$","i");var s=e.files.find(function(e){return p.test(e.name)});var u="webvtt",f="";if(!s){if(c.options.srt2vttConvertApi){var d=new RegExp("\\.(srt)$","i");s=e.files.find(function(e){return d.test(e.name)});if(s){f=e.urlList[0]+s.path;f=c.options.srt2vttConvertApi+encodeURIComponent(f)}}}else{f=e.urlList[0]+s.path}if(f){console.log("[torrent] adding subtitle: ",f);n.options.subtitle={type:u,url:f,fontSize:"25px",bottom:"10%",color:"#b7daff"};n.initSubtitle(n.options.subtitle)}}if(!o){n.notice(App.i18n.PLAY_FAILED+": "+App.i18n.NOT_FOUND_MEDIA,5e3);return}n.notice(App.i18n.READY_PLAY,5e4);o.renderTo(t,r,function(){n.container.classList.remove("dplayer-loading")})},customType:{customWebTorrent:function(t,i){i.container.classList.add("dplayer-loading");var e=new WebTorrent;var n=t.src;t.torrentId=n;t.src="";t.preload="metadata";t.addEventListener("durationchange",function(){i.container.classList.remove("dplayer-loading")},{once:true});i.notice(App.i18n.CONNECTING,5e3);var o=window.setInterval(function(){if($(c.elemPrefix()+".dplayer-notice").text()=="视频加载失败"){i.notice(App.i18n.CONNECTING,5e3);window.clearInterval(o)}},50);var r=null;var a=function(){if(o){clearInterval(o);o=null}};var l=function(){if(r){clearInterval(r);r=null}};e.add(n,function(n){console.log("[torrent] Client is downloading:",n.infoHash);c.player.torrentAdd(n,t,i);var e=function(){a();var e=Math.round(n.progress*100*100)/100;$(c.elemPrefix()+".line").html('速度 <span class="fa fa-long-arrow-down text-success"></span>'+App.formatBytes(n.downloadSpeed)+' <span class="fa fa-long-arrow-up text-danger"></span>'+App.formatBytes(n.uploadSpeed)+" 在线"+n.numPeers+"NP");$(c.elemPrefix()+".peer").text("BT已开启");var t="已加载"+e+"%";if(n.downloaded){t+=" ("+App.formatBytes(n.downloaded)+")"}if(n.length){t+=" 共"+App.formatBytes(n.length)}$(c.elemPrefix()+".load").text(t)};r=setInterval(e,5e3);e();n.on("wire",function(e,t){console.log("connected to peer with address "+t);a()});n.on("noPeers",function(e){console.log("no peers")});n.on("error",function(){a()});n.on("done",function(){l();a()})});$(c.elemPrefix()+"#video").data("webTorrent",e);i.on("destroy",function(){l();a();if(e){if(e.get(n))e.remove(n);e.destroy();e=null}$(c.elemPrefix()+"#video").data("webTorrent",null)});return e},customHls:function(e,t){var n={debug:c.options.debug};var i=null;if(c.options.p2pEngine=="p2p-media-loader"){if(p2pml.hlsjs.Engine.isSupported()){i=new p2pml.hlsjs.Engine;n.liveSyncDurationCount=7;n.loader=i.createLoaderClass()}else{c.options.p2pEngine=""}}else{n.p2pConfig={logLevel:"error",live:c.options.live,appId:c.options.p2pAppId||""};if(n.debug)n.p2pConfig.logLevel="debug";n.p2pConfig=$.extend(n.p2pConfig,c.options.p2pConfig||{})}var o=new Hls(n);if(i){p2pml.hlsjs.initHlsJsPlayer(o)}else{i=o.p2pEngine||o.engine;if(!i&&P2PEngine&&P2PEngine.isSupported()){i=new P2PEngine(o,n.p2pConfig)}}o.loadSource(e.src);o.attachMedia(e);if(i){if(c.options.p2pEngine=="p2p-media-loader"){var r=0;i.on(p2pml.core.Events.PeerConnect,function(e){r++;$(c.elemPrefix()+".line").text("在线"+(r+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on(p2pml.core.Events.PeerClose,function(e){r--;if(r<=0)r=0;$(c.elemPrefix()+".line").text("在线"+(r+1)+"NP")});var a={http:0,p2p:0},l={http:0,p2p:0};i.on(p2pml.core.Events.PieceBytesDownloaded,function(e,t,n){a[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(a.http/1024).toFixed(2)+"MB 共享"+(l.p2p/1024).toFixed(2)+"MB 加速"+(a.p2p/1024).toFixed(2)+"MB");a.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")});i.on(p2pml.core.Events.PieceBytesUploaded,function(e,t){l[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(a.http/1024).toFixed(2)+"MB 共享"+(l.p2p/1024).toFixed(2)+"MB 加速"+(a.p2p/1024).toFixed(2)+"MB");a.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")})}else{i.on("peerId",function(e){$(c.elemPrefix()+".load").text("加载0MB 共享0MB 加速0MB");$(c.elemPrefix()+".peer").text("P2P已开启");$(c.elemPrefix()+".line").text("在线1NP")});i.on("peers",function(e){$(c.elemPrefix()+".line").text("在线"+(e.length+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on("stats",function(e){$(c.elemPrefix()+".load").text("加载"+(e.totalHTTPDownloaded/1024).toFixed(2)+"MB 共享"+(e.totalP2PUploaded/1024).toFixed(2)+"MB 加速"+(e.totalP2PDownloaded/1024).toFixed(2)+"MB");e.totalP2PDownloaded?$(c.elemPrefix()+".peer").text("P2P加速中"):$(c.elemPrefix()+".peer").text("P2P已开启")})}}o.on(Hls.Events.ERROR,function(e,t){var n="";switch(t.type){case"mediaError":n="媒体错误";break;case"networkError":n="网络错误";break;default:n=t.type}n+=": ";switch(t.details){case"bufferSeekOverHole":case"bufferNudgeOnStall":case"fragLoadError":n+=t.details;console.warn(n);if(!t.fatal)return;break;case"manifestLoadError":n+="媒体加载失败";break;case"manifestLoadTimeOut":n+="媒体加载超时";break;default:n+=t.details}t.message=n;console.error(n);$(c.elemPrefix()+"#video").trigger("error",t)});$(c.elemPrefix()+"#video").data("hls",o);t.on("destroy",function(){if(o){o.destroy();o=null}$(c.elemPrefix()+"#video").data("hls",null)});return o},customDash:function(e,t){dashjs.MediaPlayer().create().initialize(e,e.src,false)},shakaDash:function(e,t){var n=e.src;var i=new shaka.Player(e);i.load(n)}},getType:function(e){var t="auto",e=String(e).split("#")[0].split("?")[0],n=e.lastIndexOf("."),i=n>-1?e.substring(n).toLowerCase():c.options.defaultExtName;if(e.substring(0,7).toLowerCase()=="magnet:"||i==".torrent"){t="customWebTorrent"}else if(i==".m3u8"){t="customHls"}else if(i==".mpd"){t="customDash"}else if(c.options.defaultType){t=c.options.defaultType}return t},eplayer:function(e){var t=$.extend(c.options,e||{});var n=c.player.getType(t.urls);var i=c.elemPrefix();var o=i?$(i).find("video"):null;if(!o||o.length<1)o=document.getElementById("video");var r=new DPlayer({container:o,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:true,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,type:n,pic:t.pics,customType:c.player.customType}});r.on("loadstart",function(){var e=$(c.elemPrefix()+"video");e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");if(r.video.paused)$(c.elemPrefix()+".play").show()});r.on("loadeddata",function(){a(c.options,r)});r.on("timeupdate",function(){l(c.options,r,r.video.currentTime)});r.on("ended",function(){c.jump(c.options.jump)});r.on("pause",function(){$(c.elemPrefix()+".play").show()});r.on("play",function(){$(c.elemPrefix()+".play").hide()});r.on("error",function(){});$(c.elemPrefix()+".play").click(function(){r.play()});$(c.elemPrefix()+"#video").data("player",r);return r},dplayer:function(e){var t=$.extend(c.options,e||{});var n=new DPlayer({container:document.getElementById("video"),autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:true,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,pic:t.pics}});n.on("loadstart",function(){var e=$(c.elemPrefix()+"video");e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");if(n.video.paused)$(c.elemPrefix()+".play").show()});n.on("loadeddata",function(){a(c.options,n)});n.on("timeupdate",function(){l(c.options,n,n.video.currentTime)});n.on("ended",function(){c.jump(c.options.jump)});n.on("pause",function(){$(c.elemPrefix()+".play").show()});n.on("play",function(){$(c.elemPrefix()+".play").hide()});$(c.elemPrefix()+".play").click(function(){n.play()});$(c.elemPrefix()+"#video").data("player",n);return n}},cookie:{data:{},set:function(e,t,n){var i=new Date;i.setTime(i.getTime()+n*24*60*60*1e3);var o=e+"="+escape(t)+";path="+window.location.pathname+";expires="+i.toUTCString()+";sameSite=Lax";if(c.secure)o+=";secure=true";document.cookie=o;c.cookie.data[e]=t},get:function(e){if(typeof c.cookie.data[e]!="undefined")return c.cookie.data[e];var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));if(t!=null)return unescape(t[2])},put:function(e){var t=e.replace(/[^a-z0-9]+/gi,"");var t=t.substring(t.length-32);return t}},jump:function(e){if(!e)return;if($.isFunction(e)){return e()}top.location.href=e}};function a(e,t){if(e.live)return;if(e.autoSkip&&e.seek<=0&&e.filmRange&&e.filmRange.playRange.min>0){e.seek=e.filmRange.playRange.min}var n=e.take?c.cookie.get(e.take):0;var i=t.video.currentTime;if(!n){if(i==e.seek)return;return t.seek(e.seek)}if(t.video.duration-n<60||e.seek>n){if(i==e.seek)return;t.seek(e.seek)}else{if(i==n)return;t.seek(n)}}function l(e,t,n){if(e.trys>0&&n>e.trys){$(t.video).trigger("endoftrial",e,t,n);t.notice("试看结束");return t.pause()}if(e.live)return;if(e.take)c.cookie.set(e.take,n,30);if(!e.autoSkip||!e.filmRange)return;var i=e.filmRange;if(i.playRange.min>0&&n<i.playRange.min){return t.seek(i.playRange.min)}if(i.playRange.max<0&&i.playRange.max*-1<t.video.duration)i.playRange.max=t.video.duration+i.playRange.max;if(i.playRange.max>0&&n>=i.playRange.max){return c.jump(e.jump)}if(!i.skipRange)return;for(var o=0;i.skipRange.length;o++){var r=i.skipRange[o];if(n>=r.min){if(r.max<0&&r.max*-1<t.video.duration)r.max=t.video.duration+r.max;if(n<r.max){return t.seek(r.max)}}}}e.amplayer=c})(window);