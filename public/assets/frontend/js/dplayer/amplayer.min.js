(function(s){var c={options:{autoPlay:true,screenshot:false,airplay:true,chromecast:true,live:false,logo:"",urls:"",pics:"",autoSkip:true,autoSkipAd:true,autoNext:true,debug:false,trys:0,seek:0,take:"",seq:"",jump:"",p2pAppId:"",p2pEngine:"",p2pConfig:{},srt2vttConvertApi:"",container:"",defaultType:"customHls",defaultExtName:".m3u8",touchVideoChangeProgress:false,listeners:{}},secure:s.location.protocol=="https:",elemPrefix:function(e){return c.options.container?c.options.container+(!e?" ":""):""},player:{torrentAdd:function(e,t,n){n.notice(App.i18n.CONNECTED,5e3);var o=new RegExp("\\.(mp4)$","i");var r=e.files.find(function(e){console.log("[torrent] adding file: ",e.path||e.name);return o.test(e.name)});var i={autoplay:n.options.autoplay};if(e.urlList&&e.urlList.length>0){var a=new RegExp("poster\\.(jp[e]?g|png|gif|webp|svg)$","i");var l=e.files.find(function(e){return a.test(e.name)});if(l){l=e.urlList[0]+l.path;console.log("[torrent] adding cover: ",l);$(c.elemPrefix()+"video").attr("poster",l)}var s=new RegExp("\\.(vtt)$","i");var p=e.files.find(function(e){return s.test(e.name)});var u="webvtt",f="";if(!p){if(c.options.srt2vttConvertApi){var d=new RegExp("\\.(srt)$","i");p=e.files.find(function(e){return d.test(e.name)});if(p){f=e.urlList[0]+p.path;f=c.options.srt2vttConvertApi+encodeURIComponent(f)}}}else{f=e.urlList[0]+p.path}if(f){console.log("[torrent] adding subtitle: ",f);n.options.subtitle={type:u,url:f,fontSize:"25px",bottom:"10%",color:"#b7daff"};n.initSubtitle(n.options.subtitle)}}if(!r){n.notice(App.i18n.PLAY_FAILED+": "+App.i18n.NOT_FOUND_MEDIA,5e3);return}n.notice(App.i18n.READY_PLAY,5e4);r.renderTo(t,i,function(){n.container.classList.remove("dplayer-loading")})},customType:{customWebTorrent:function(t,o){o.container.classList.add("dplayer-loading");var e=new WebTorrent;var n=t.src;t.torrentId=n;t.src="";t.preload="metadata";t.addEventListener("durationchange",function(){o.container.classList.remove("dplayer-loading")},{once:true});o.notice(App.i18n.CONNECTING,5e3);var r=s.setInterval(function(){if($(c.elemPrefix()+".dplayer-notice").text()=="视频加载失败"){o.notice(App.i18n.CONNECTING,5e3);s.clearInterval(r)}},50);var i=null;var a=function(){if(r){clearInterval(r);r=null}};var l=function(){if(i){clearInterval(i);i=null}};e.add(n,function(n){console.log("[torrent] Client is downloading:",n.infoHash);c.player.torrentAdd(n,t,o);var e=function(){a();var e=Math.round(n.progress*100*100)/100;$(c.elemPrefix()+".line").html('速度 <span class="fa fa-long-arrow-down text-success"></span>'+App.formatBytes(n.downloadSpeed)+' <span class="fa fa-long-arrow-up text-danger"></span>'+App.formatBytes(n.uploadSpeed)+" 在线"+n.numPeers+"NP");$(c.elemPrefix()+".peer").text("BT已开启");var t="已加载"+e+"%";if(n.downloaded){t+=" ("+App.formatBytes(n.downloaded)+")"}if(n.length){t+=" 共"+App.formatBytes(n.length)}$(c.elemPrefix()+".load").text(t)};i=setInterval(e,5e3);e();n.on("wire",function(e,t){console.log("connected to peer with address "+t);a()});n.on("noPeers",function(e){console.log("no peers")});n.on("error",function(){a()});n.on("done",function(){l();a()})});$(c.elemPrefix()+"#video").data("webTorrent",e);o.on("destroy",function(){l();a();if(e){if(e.get(n))e.remove(n);e.destroy();e=null}$(c.elemPrefix()+"#video").data("webTorrent",null)});return e},customHls:function(e,t){var n=$(c.elemPrefix()+"#video");if(n.data("hls")){var o=n.data("eventIndex");t.trigger("destroy");if(o!==null)t.off("destroy",o)}var r=$.extend({debug:c.options.debug,enableWorker:true,maxMaxBufferLength:100,maxBufferSize:0,maxBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,liveBackBufferLength:15,liveSyncDurationCount:1},t.options.pluginOptions.hls||{});var i=null;if(c.options.p2pEngine=="p2p-media-loader"){if(p2pml.hlsjs.Engine.isSupported()){i=new p2pml.hlsjs.Engine;r.liveSyncDurationCount=7;r.loader=i.createLoaderClass()}else{c.options.p2pEngine=""}}else{r.p2pConfig={logLevel:"error",live:c.options.live,appId:c.options.p2pAppId||""};if(r.debug)r.p2pConfig.logLevel="debug";r.p2pConfig=$.extend(r.p2pConfig,c.options.p2pConfig||{})}var a=new Hls(r);if(i){p2pml.hlsjs.initHlsJsPlayer(a)}else{i=a.p2pEngine||a.engine;if(!i&&P2PEngine&&P2PEngine.isSupported()){i=new P2PEngine(a,r.p2pConfig)}}a.loadSource(e.src);a.attachMedia(e);if(i){if(c.options.p2pEngine=="p2p-media-loader"){var l=0;i.on(p2pml.core.Events.PeerConnect,function(e){l++;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on(p2pml.core.Events.PeerClose,function(e){l--;if(l<=0)l=0;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP")});var s={http:0,p2p:0},p={http:0,p2p:0};i.on(p2pml.core.Events.PieceBytesDownloaded,function(e,t,n){s[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(s.http/1024).toFixed(2)+"MB 共享"+(p.p2p/1024).toFixed(2)+"MB 加速"+(s.p2p/1024).toFixed(2)+"MB");s.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")});i.on(p2pml.core.Events.PieceBytesUploaded,function(e,t){p[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(s.http/1024).toFixed(2)+"MB 共享"+(p.p2p/1024).toFixed(2)+"MB 加速"+(s.p2p/1024).toFixed(2)+"MB");s.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")})}else{i.on("peerId",function(e){$(c.elemPrefix()+".load").text("加载0MB 共享0MB 加速0MB");$(c.elemPrefix()+".peer").text("P2P已开启");$(c.elemPrefix()+".line").text("在线1NP")});i.on("peers",function(e){$(c.elemPrefix()+".line").text("在线"+(e.length+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on("stats",function(e){$(c.elemPrefix()+".load").text("加载"+(e.totalHTTPDownloaded/1024).toFixed(2)+"MB 共享"+(e.totalP2PUploaded/1024).toFixed(2)+"MB 加速"+(e.totalP2PDownloaded/1024).toFixed(2)+"MB");e.totalP2PDownloaded?$(c.elemPrefix()+".peer").text("P2P加速中"):$(c.elemPrefix()+".peer").text("P2P已开启")})}}var u,f,d;a.on(Hls.Events.ERROR,function(e,t){var n="";switch(t.type){case"mediaError":n="媒体错误";var o=c.options.autoRecoverMediaError||false;if(o&&t.fatal){var r=(new Date).getTime();if(!u||r-u>3e3){u=r;a.recoverMediaError();return}if(!f||r-f>3e3){f=r;a.swapAudioCodec();a.recoverMediaError();return}}break;case"networkError":n="网络错误";var o=c.options.autoRecoverNetworkError||false;if(o&&t.fatal){var r=(new Date).getTime();if(!d||r-d>3e3){d=r;a.startLoad();return}}break;default:n=t.type}n+=": ";switch(t.details){case"bufferFullError":case"bufferSeekOverHole":case"bufferNudgeOnStall":case"fragLoadError":if(!t.fatal)return;n+=t.details;break;case"manifestLoadError":n+="媒体加载失败";break;case"manifestLoadTimeOut":n+="媒体加载超时";break;default:n+=t.details}t.message=n;console.error(n);$(c.elemPrefix()+"#video").trigger("error",t)});n.data("hls",a);var o=t.on("destroy",function(){if(a){a.destroy();if(c.options.debug)console.debug("hls destory.");a=null}if(i){if(typeof i.destroy=="function"){i.destroy();if(c.options.debug)console.debug("p2p engine destory.")}i=null}$(c.elemPrefix()+"#video").data("hls",null)});n.data("eventIndex",o);return a},shakaDash:function(e,t){var n=e.src;var o=new shaka.Player(e);o.load(n)}},getType:function(e){var t="auto",e=String(e).split("#")[0].split("?")[0],n=e.lastIndexOf("."),o=n>-1?e.substring(n).toLowerCase():c.options.defaultExtName;if(e.substring(0,7).toLowerCase()=="magnet:"||o==".torrent"){t="customWebTorrent"}else if(o==".m3u8"){t="customHls"}else if(o==".mpd"){t="dash"}else if(o==".flv"){t="flv"}else if(o==".mp4"||o==".mp3"||o==".webm"||o==".ogg"||o==".mkv"){t="normal"}else if(c.options.defaultType){t=c.options.defaultType}return t},eplayer:function(e){var t=$.extend(c.options,e||{});var n=c.player.getType(t.urls);var o=a();var r={container:o,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,type:n,pic:t.pics,customType:c.player.customType},touchVideoChangeProgress:t.touchVideoChangeProgress,pluginOptions:{}};switch(n){case"flv":r.pluginOptions.flv={config:{isLive:t.live,autoCleanupSourceBuffer:true,autoCleanupMinBackwardDuration:60}};break;case"hls":r.pluginOptions.hls={enableWorker:true,liveBackBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,maxBufferSize:0,maxBufferLength:10,liveSyncDurationCount:1};break}r.pluginOptions=$.extend(r.pluginOptions,t.pluginOptions||{});var i=new DPlayer(r);l(i);$(c.elemPrefix()+"#video").data("player",i);return i},dplayer:function(e){var t=$.extend(c.options,e||{});var n=a();var o=new DPlayer({container:n,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],touchVideoChangeProgress:t.touchVideoChangeProgress,video:{url:t.urls,pic:t.pics}});l(o);$(c.elemPrefix()+"#video").data("player",o);return o}},cookie:{data:{},set:function(e,t,n){var o=new Date;o.setTime(o.getTime()+n*24*60*60*1e3);var r=e+"="+escape(t)+";path="+s.location.pathname+";expires="+o.toUTCString()+";sameSite=Lax";if(c.secure)r+=";secure=true";document.cookie=r;c.cookie.data[e]=t},get:function(e){if(typeof c.cookie.data[e]!="undefined")return c.cookie.data[e];var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));if(t!=null)return unescape(t[2])},remove:function(e){c.cookie.set(e,"",-10)}},localStorage:{data:{},set:function(e,t,n){if(t===undefined){return c.localStorage.remove(e)}s.localStorage.setItem(e,t);c.localStorage.data[e]=t},get:function(e){if(typeof c.localStorage.data[e]!="undefined")return c.localStorage.data[e];return s.localStorage.getItem(e)},remove:function(e){s.localStorage.removeItem(e)}},store:{set:function(e,t,n){return o().set(e,t,n)},get:function(e){return o().get(e)},remove:function(e){return o().remove(e)}},jump:function(e){if(!e)return;if($.isFunction(e)){return e()}top.location.href=e}};var t=null;function e(){if(t!==null){return t}try{t="localStorage"in s}catch(e){t=false}return t}function a(){var e=c.elemPrefix(true);var t=e?$(e).find("#video"):null;if(!t||t.length<1)t=document.getElementById("video");else if(t.length>0)t=t[0];return t}function o(){if(e())return c.localStorage;return c.cookie}function n(e,t,n){if(!c.options.listeners)return;if(typeof c.options.listeners[e]!="function")return;c.options.listeners[e].call(t,n)}function l(t){t.on("loadstart",function(){var e=$(t.video);e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");if(t.video.paused&&!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").show();n("loadstart",this,arguments)});t.on("loadeddata",function(){r(c.options,t);n("loadeddata",this,arguments)});t.on("timeupdate",function(){i(c.options,t,t.video.currentTime);n("timeupdate",this,arguments)});t.on("ended",function(){n("ended",this,arguments);c.jump(c.options.jump)});t.on("pause",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").show();n("pause",this,arguments)});t.on("play",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").hide();n("play",this,arguments)});t.on("error",function(){n("error",this,arguments)});$(c.elemPrefix()+".amplayer-play").off("click").on("click",function(){t.play()});$(c.elemPrefix()+".amplayer-backward").off("click").on("click",function(){let e=Math.max(t.video.currentTime-10,0);t.seek(e);t.controller.setAutoHide()});$(c.elemPrefix()+".amplayer-forward").off("click").on("click",function(){let e=Math.min(t.video.currentTime+10,t.video.duration);t.seek(e);t.controller.setAutoHide()})}function r(e,t){if(e.live)return;if(e.autoSkip&&e.seek<=0&&e.filmRange&&e.filmRange.playRange.min>0){e.seek=e.filmRange.playRange.min}var n=e.take?c.store.get(e.take):0;var o=t.video.currentTime;if(!n){if(o==e.seek)return;return t.seek(e.seek)}if(t.video.duration-n<60||e.seek>n){if(o==e.seek)return;t.seek(e.seek)}else{if(o==n)return;t.seek(n)}}function i(e,t,n){if(e.trys>0&&n>e.trys){$(t.video).trigger("endoftrial",e,t,n);t.notice("试看结束");return t.pause()}if(e.live)return;if(e.take)c.store.set(e.take,n,30);if(e.filmRange&&(e.autoSkip||e.autoSkipAd)){var o=e.filmRange;if(e.autoSkip){if(o.playRange.min>0&&n<o.playRange.min){return t.seek(o.playRange.min)}var r=o.playRange.max;if(r<0&&r*-1<t.video.duration)r=t.video.duration+r;if(r>0&&n>=r){return c.jump(e.jump)}}if(e.autoSkipAd&&o.skipRange){for(var i=0;o.skipRange.length;i++){var a=o.skipRange[i];if(n>=a.min){if(a.max<0&&a.max*-1<t.video.duration)a.max=t.video.duration+a.max;if(n<a.max){return t.seek(a.max)}}}}}}s.amplayer=c})(window);