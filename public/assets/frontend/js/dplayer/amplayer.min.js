(function(s){var c={options:{autoPlay:true,screenshot:false,airplay:true,chromecast:true,live:false,logo:"",urls:"",pics:"",autoSkip:true,autoSkipAd:true,autoNext:true,debug:false,trys:0,seek:0,take:"",seq:"",jump:"",p2pAppId:"",p2pEngine:"",p2pConfig:{},srt2vttConvertApi:"",container:"",defaultType:"customHls",defaultExtName:".m3u8",touchVideoChangeProgress:false,listeners:{}},secure:s.location.protocol=="https:",elemPrefix:function(e){return c.options.container?c.options.container+(!e?" ":""):""},player:{torrentAdd:function(e,t,o){o.notice(App.i18n.CONNECTED,5e3);var n=new RegExp("\\.(mp4)$","i");var r=e.files.find(function(e){console.log("[torrent] adding file: ",e.path||e.name);return n.test(e.name)});var i={autoplay:o.options.autoplay};if(e.urlList&&e.urlList.length>0){var a=new RegExp("poster\\.(jp[e]?g|png|gif|webp|svg)$","i");var l=e.files.find(function(e){return a.test(e.name)});if(l){l=e.urlList[0]+l.path;console.log("[torrent] adding cover: ",l);$(c.elemPrefix()+"video").attr("poster",l)}var s=new RegExp("\\.(vtt)$","i");var p=e.files.find(function(e){return s.test(e.name)});var u="webvtt",f="";if(!p){if(c.options.srt2vttConvertApi){var d=new RegExp("\\.(srt)$","i");p=e.files.find(function(e){return d.test(e.name)});if(p){f=e.urlList[0]+p.path;f=c.options.srt2vttConvertApi+encodeURIComponent(f)}}}else{f=e.urlList[0]+p.path}if(f){console.log("[torrent] adding subtitle: ",f);o.options.subtitle={type:u,url:f,fontSize:"25px",bottom:"10%",color:"#b7daff"};o.initSubtitle(o.options.subtitle)}}if(!r){o.notice(App.i18n.PLAY_FAILED+": "+App.i18n.NOT_FOUND_MEDIA,5e3);return}o.notice(App.i18n.READY_PLAY,5e4);r.renderTo(t,i,function(){o.container.classList.remove("dplayer-loading")})},customType:{customWebTorrent:function(t,n){n.container.classList.add("dplayer-loading");var e=new WebTorrent;var o=t.src;t.torrentId=o;t.src="";t.preload="metadata";t.addEventListener("durationchange",function(){n.container.classList.remove("dplayer-loading")},{once:true});n.notice(App.i18n.CONNECTING,5e3);var r=s.setInterval(function(){if($(c.elemPrefix()+".dplayer-notice").text()=="视频加载失败"){n.notice(App.i18n.CONNECTING,5e3);s.clearInterval(r)}},50);var i=null;var a=function(){if(r){clearInterval(r);r=null}};var l=function(){if(i){clearInterval(i);i=null}};e.add(o,function(o){console.log("[torrent] Client is downloading:",o.infoHash);c.player.torrentAdd(o,t,n);var e=function(){a();var e=Math.round(o.progress*100*100)/100;$(c.elemPrefix()+".line").html('速度 <span class="fa fa-long-arrow-down text-success"></span>'+App.formatBytes(o.downloadSpeed)+' <span class="fa fa-long-arrow-up text-danger"></span>'+App.formatBytes(o.uploadSpeed)+" 在线"+o.numPeers+"NP");$(c.elemPrefix()+".peer").text("BT已开启");var t="已加载"+e+"%";if(o.downloaded){t+=" ("+App.formatBytes(o.downloaded)+")"}if(o.length){t+=" 共"+App.formatBytes(o.length)}$(c.elemPrefix()+".load").text(t)};i=setInterval(e,5e3);e();o.on("wire",function(e,t){console.log("connected to peer with address "+t);a()});o.on("noPeers",function(e){console.log("no peers")});o.on("error",function(){a()});o.on("done",function(){l();a()})});$(c.elemPrefix()+"#video").data("webTorrent",e);n.on("destroy",function(){l();a();if(e){if(e.get(o))e.remove(o);e.destroy();e=null}$(c.elemPrefix()+"#video").data("webTorrent",null)});return e},customHls:function(e,t){var o=$(c.elemPrefix()+"#video");if(o.data("hls")){var n=o.data("eventIndex");t.trigger("destroy");if(n!==null)t.off("destroy",n)}var r=$.extend({debug:c.options.debug,enableWorker:true,maxMaxBufferLength:100,maxBufferSize:0,maxBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,liveBackBufferLength:15,liveSyncDurationCount:1},t.options.pluginOptions.hls||{});var i=null;if(c.options.p2pEngine=="p2p-media-loader"){if(p2pml.hlsjs.Engine.isSupported()){i=new p2pml.hlsjs.Engine;r.liveSyncDurationCount=7;r.loader=i.createLoaderClass()}else{c.options.p2pEngine=""}}else{r.p2pConfig={logLevel:"error",showSlogan:false,live:c.options.live,appId:c.options.p2pAppId||""};if(r.debug)r.p2pConfig.logLevel="debug";r.p2pConfig=$.extend(r.p2pConfig,c.options.p2pConfig||{})}var a=new Hls(r);if(i){p2pml.hlsjs.initHlsJsPlayer(a)}else{i=a.p2pEngine||a.engine;if(!i&&P2PEngine&&P2PEngine.isSupported()){i=new P2PEngine(a,r.p2pConfig)}}a.loadSource(e.src);a.attachMedia(e);if(i){if(c.options.p2pEngine=="p2p-media-loader"){var l=0;i.on(p2pml.core.Events.PeerConnect,function(e){l++;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on(p2pml.core.Events.PeerClose,function(e){l--;if(l<=0)l=0;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP")});var s={http:0,p2p:0},p={http:0,p2p:0};i.on(p2pml.core.Events.PieceBytesDownloaded,function(e,t,o){s[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(s.http/1024).toFixed(2)+"MB 共享"+(p.p2p/1024).toFixed(2)+"MB 加速"+(s.p2p/1024).toFixed(2)+"MB");s.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")});i.on(p2pml.core.Events.PieceBytesUploaded,function(e,t){p[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(s.http/1024).toFixed(2)+"MB 共享"+(p.p2p/1024).toFixed(2)+"MB 加速"+(s.p2p/1024).toFixed(2)+"MB");s.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")})}else{i.on("peerId",function(e){$(c.elemPrefix()+".load").text("加载0MB 共享0MB 加速0MB");$(c.elemPrefix()+".peer").text("P2P已开启");$(c.elemPrefix()+".line").text("在线1NP")});i.on("peers",function(e){$(c.elemPrefix()+".line").text("在线"+(e.length+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on("stats",function(e){$(c.elemPrefix()+".load").text("加载"+(e.totalHTTPDownloaded/1024).toFixed(2)+"MB 共享"+(e.totalP2PUploaded/1024).toFixed(2)+"MB 加速"+(e.totalP2PDownloaded/1024).toFixed(2)+"MB");e.totalP2PDownloaded?$(c.elemPrefix()+".peer").text("P2P加速中"):$(c.elemPrefix()+".peer").text("P2P已开启")})}}var u,f,d;a.on(Hls.Events.ERROR,function(e,t){var o="";switch(t.type){case"mediaError":o="媒体错误";var n=c.options.autoRecoverMediaError||false;if(n&&t.fatal){var r=(new Date).getTime();if(!u||r-u>3e3){u=r;a.recoverMediaError();return}if(!f||r-f>3e3){f=r;a.swapAudioCodec();a.recoverMediaError();return}}break;case"networkError":o="网络错误";var n=c.options.autoRecoverNetworkError||false;if(n&&t.fatal){var r=(new Date).getTime();if(!d||r-d>3e3){d=r;a.startLoad();return}}break;default:o=t.type}o+=": ";switch(t.details){case"bufferFullError":case"bufferSeekOverHole":case"bufferNudgeOnStall":case"fragLoadError":if(!t.fatal)return;o+=t.details;break;case"manifestLoadError":o+="媒体加载失败";break;case"manifestLoadTimeOut":o+="媒体加载超时";break;default:o+=t.details}t.message=o;console.error(o);$(c.elemPrefix()+"#video").trigger("error",t)});o.data("hls",a);var n=t.on("destroy",function(){if(a){a.destroy();if(c.options.debug)console.debug("hls destory.");a=null}if(i){if(typeof i.destroy=="function"){i.destroy();if(c.options.debug)console.debug("p2p engine destory.")}i=null}$(c.elemPrefix()+"#video").data("hls",null)});o.data("eventIndex",n);return a},shakaDash:function(e,t){var o=e.src;var n=new shaka.Player(e);n.load(o)}},getType:function(e){var t="auto",e=String(e).split("#")[0].split("?")[0],o=e.lastIndexOf("."),n=o>-1?e.substring(o).toLowerCase():c.options.defaultExtName;if(e.substring(0,7).toLowerCase()=="magnet:"||n==".torrent"){t="customWebTorrent"}else if(n==".m3u8"){t="customHls"}else if(n==".mpd"){t="dash"}else if(n==".flv"){t="flv"}else if(n==".mp4"||n==".mp3"||n==".webm"||n==".ogg"||n==".mkv"){t="normal"}else if(c.options.defaultType){t=c.options.defaultType}return t},eplayer:function(e){var t=$.extend(c.options,e||{});var o=c.player.getType(t.urls);var n=a();var r={container:n,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,type:o,pic:t.pics,customType:c.player.customType},touchVideoChangeProgress:t.touchVideoChangeProgress,pluginOptions:{}};switch(o){case"flv":r.pluginOptions.flv={config:{isLive:t.live,autoCleanupSourceBuffer:true,autoCleanupMinBackwardDuration:60}};break;case"hls":r.pluginOptions.hls={enableWorker:true,liveBackBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,maxBufferSize:0,maxBufferLength:10,liveSyncDurationCount:1};break}r.pluginOptions=$.extend(r.pluginOptions,t.pluginOptions||{});var i=new DPlayer(r);l(i);$(c.elemPrefix()+"#video").data("player",i);return i},dplayer:function(e){var t=$.extend(c.options,e||{});var o=a();var n=new DPlayer({container:o,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],touchVideoChangeProgress:t.touchVideoChangeProgress,video:{url:t.urls,pic:t.pics}});l(n);$(c.elemPrefix()+"#video").data("player",n);return n}},cookie:{data:{},set:function(e,t,o,n){var r=new Date;if(!o)o=30;r.setTime(r.getTime()+o*24*60*60*1e3);var i=e+"="+escape(t)+";path="+(n?n:s.location.pathname)+";expires="+r.toUTCString()+";sameSite=Lax";if(c.secure)i+=";secure=true";document.cookie=i;c.cookie.data[e]=t},get:function(e){if(typeof c.cookie.data[e]!="undefined")return c.cookie.data[e];var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));if(t!=null)return unescape(t[2])},remove:function(e){c.cookie.set(e,"",-10)}},localStorage:{data:{},set:function(e,t,o,n){if(t===undefined){return c.localStorage.remove(e)}s.localStorage.setItem(e,t);c.localStorage.data[e]=t},get:function(e){if(typeof c.localStorage.data[e]!="undefined")return c.localStorage.data[e];return s.localStorage.getItem(e)},remove:function(e){s.localStorage.removeItem(e)}},store:{set:function(e,t,o,n){return r().set(e,t,o,n)},get:function(e){return r().get(e)},remove:function(e){return r().remove(e)}},jump:function(e){if(!e)return;if($.isFunction(e)){return e()}top.location.href=e}};var t=null;function e(){if(t!==null){return t}try{t="localStorage"in s}catch(e){t=false}return t}function a(){var e=c.elemPrefix(true);var t=e?$(e).find("#video"):null;if(!t||t.length<1)t=document.getElementById("video");else if(t.length>0)t=t[0];return t}function r(){if(e())return c.localStorage;return c.cookie}function o(e,t,o){if(!c.options.listeners)return;if(typeof c.options.listeners[e]!="function")return;c.options.listeners[e].call(t,o)}function l(t){t.on("loadstart",function(){var e=$(t.video);e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");e.removeAttr("disableremoteplayback");if(t.video.paused&&!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").show();o("loadstart",this,arguments)});t.on("loadeddata",function(){n(c.options,t);o("loadeddata",this,arguments)});t.on("timeupdate",function(){i(c.options,t,t.video.currentTime);o("timeupdate",this,arguments)});t.on("ended",function(){o("ended",this,arguments);c.jump(c.options.jump)});t.on("pause",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").show();o("pause",this,arguments)});t.on("play",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(c.elemPrefix()+".amplayer-center-button").hide();o("play",this,arguments)});t.on("error",function(){o("error",this,arguments)});$(c.elemPrefix()+".amplayer-play").off("click").on("click",function(){t.play()});$(c.elemPrefix()+".amplayer-backward").off("click").on("click",function(){let e=Math.max(t.video.currentTime-10,0);t.seek(e);t.controller.setAutoHide()});$(c.elemPrefix()+".amplayer-forward").off("click").on("click",function(){let e=Math.min(t.video.currentTime+10,t.video.duration);t.seek(e);t.controller.setAutoHide()})}function n(e,t){if(e.live)return;if(e.autoSkip&&e.seek<=0&&e.filmRange&&e.filmRange.playRange.min>0){e.seek=e.filmRange.playRange.min}var o=e.take?c.store.get(e.take):0;var n=t.video.currentTime;if(!o){if(n==e.seek)return;return t.seek(e.seek)}if(t.video.duration-o<60||e.seek>o){if(n==e.seek)return;t.seek(e.seek)}else{if(n==o)return;t.seek(o)}}function i(e,t,o){if(e.trys>0&&o>e.trys){$(t.video).trigger("endoftrial",e,t,o);t.notice("试看结束");return t.pause()}if(e.live)return;if(e.take)c.store.set(e.take,o,30);if(e.filmRange&&(e.autoSkip||e.autoSkipAd)){var n=e.filmRange;if(e.autoSkip){if(n.playRange.min>0&&o<n.playRange.min){return t.seek(n.playRange.min)}var r=n.playRange.max;if(r<0&&r*-1<t.video.duration)r=t.video.duration+r;if(r>0&&o>=r){return c.jump(e.jump)}}if(e.autoSkipAd&&n.skipRange){for(var i=0;n.skipRange.length;i++){var a=n.skipRange[i];if(o>=a.min){if(a.max<0&&a.max*-1<t.video.duration)a.max=t.video.duration+a.max;if(o<a.max){return t.seek(a.max)}}}}}}s.amplayer=c})(window);