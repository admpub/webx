(function(s){var h={options:{autoPlay:true,screenshot:true,airplay:true,chromecast:true,live:false,logo:"",urls:"",pics:"",autoSkip:true,autoSkipAd:true,autoNext:true,debug:false,trys:0,seek:0,take:"",seq:"",jump:"",p2pAppId:"",p2pEngine:"",p2pConfig:{},srt2vttConvertApi:"",container:"",defaultType:"customHls",defaultExtName:".m3u8",touchVideoChangeProgress:false,disableRemotePlayback:false,contextmenu:null,listeners:{},customSettings:[]},secure:s.location.protocol=="https:",elemPrefix:function(e){return h.options.container?h.options.container+(!e?" ":""):""},player:{torrentAdd:function(e,t,n){n.notice(App.i18n.CONNECTED,5e3);var o=new RegExp("\\.(mp4)$","i");var r=e.files.find(function(e){console.log("[torrent] adding file: ",e.path||e.name);return o.test(e.name)});var i={autoplay:n.options.autoplay};if(e.urlList&&e.urlList.length>0){var a=new RegExp("poster\\.(jp[e]?g|png|gif|webp|svg)$","i");var l=e.files.find(function(e){return a.test(e.name)});if(l){l=e.urlList[0]+l.path;console.log("[torrent] adding cover: ",l);$(h.elemPrefix()+"video").attr("poster",l)}var s=new RegExp("\\.(vtt)$","i");var u=e.files.find(function(e){return s.test(e.name)});var f="webvtt",p="";if(!u){if(h.options.srt2vttConvertApi){var d=new RegExp("\\.(srt)$","i");u=e.files.find(function(e){return d.test(e.name)});if(u){p=e.urlList[0]+u.path;p=h.options.srt2vttConvertApi+encodeURIComponent(p)}}}else{p=e.urlList[0]+u.path}if(p){console.log("[torrent] adding subtitle: ",p);n.options.subtitle={type:f,url:p,fontSize:"25px",bottom:"10%",color:"#b7daff"};n.initSubtitle(n.options.subtitle)}}if(!r){n.notice(App.i18n.PLAY_FAILED+": "+App.i18n.NOT_FOUND_MEDIA,5e3);return}n.notice(App.i18n.READY_PLAY,5e4);r.renderTo(t,i,function(){n.container.classList.remove("dplayer-loading")})},customType:{customWebTorrent:function(t,o){o.container.classList.add("dplayer-loading");var e=new WebTorrent;var n=t.src;t.torrentId=n;t.src="";t.preload="metadata";t.addEventListener("durationchange",function(){o.container.classList.remove("dplayer-loading")},{once:true});o.notice(App.i18n.CONNECTING,5e3);var r=s.setInterval(function(){if($(h.elemPrefix()+".dplayer-notice").text()=="视频加载失败"){o.notice(App.i18n.CONNECTING,5e3);s.clearInterval(r)}},50);var i=null;var a=function(){if(r){clearInterval(r);r=null}};var l=function(){if(i){clearInterval(i);i=null}};e.add(n,function(n){console.log("[torrent] Client is downloading:",n.infoHash);h.player.torrentAdd(n,t,o);var e=function(){a();var e=Math.round(n.progress*100*100)/100;$(h.elemPrefix()+".line").html('速度 <span class="fa fa-long-arrow-down text-success"></span>'+App.formatBytes(n.downloadSpeed)+' <span class="fa fa-long-arrow-up text-danger"></span>'+App.formatBytes(n.uploadSpeed)+" 在线"+n.numPeers+"NP");$(h.elemPrefix()+".peer").text("BT已开启");var t="已加载"+e+"%";if(n.downloaded){t+=" ("+App.formatBytes(n.downloaded)+")"}if(n.length){t+=" 共"+App.formatBytes(n.length)}$(h.elemPrefix()+".load").text(t)};i=setInterval(e,5e3);e();n.on("wire",function(e,t){console.log("connected to peer with address "+t);a()});n.on("noPeers",function(e){console.log("no peers")});n.on("error",function(){a()});n.on("done",function(){l();a()})});$(h.elemPrefix()+"#video").data("webTorrent",e);o.on("destroy",function(){l();a();if(e){if(e.get(n))e.remove(n);e.destroy();e=null}$(h.elemPrefix()+"#video").data("webTorrent",null)});return e},customHls:function(e,t){var n=$(h.elemPrefix()+"#video");if(n.data("hls")){var o=n.data("eventIndex");t.trigger("destroy");if(o!==null)t.off("destroy",o)}var r=$.extend({debug:h.options.debug,enableWorker:true,maxMaxBufferLength:100,maxBufferSize:0,maxBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,liveBackBufferLength:15,liveSyncDurationCount:1},t.options.pluginOptions.hls||{});var i=e.src,a=null,l=null;if(h.options.p2pEngine=="p2p-media-loader"){function s(e){var t=0;e.addEventListener("onPeerConnect",function(e){t++;$(h.elemPrefix()+".line").text("在线"+(t+1)+"NP");$(h.elemPrefix()+".peer").text("P2P已开启")});e.addEventListener("onPeerClose",function(e){t--;if(t<=0)t=0;$(h.elemPrefix()+".line").text("在线"+(t+1)+"NP")});var o={http:0,p2p:0},r=0;e.addEventListener("onChunkDownloaded",function(e,t,n){o[t]+=e/1024;$(h.elemPrefix()+".load").text("加载"+(o.http/1024).toFixed(2)+"MB 共享"+(r/1024).toFixed(2)+"MB 加速"+(o.p2p/1024).toFixed(2)+"MB");o.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")});e.addEventListener("onChunkUploaded",function(e,t){r+=e/1024;$(h.elemPrefix()+".load").text("加载"+(o.http/1024).toFixed(2)+"MB 共享"+(r/1024).toFixed(2)+"MB 加速"+(o.p2p/1024).toFixed(2)+"MB");o.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")})}const x=HlsJsP2PEngine.injectMixin(window.Hls);var u={core:{swarmId:i}};u=$.extend(u,h.options.p2pConfig||{});var f="/proxy/",p=u.core.swarmId.indexOf(f);if(p>0)u.core.swarmId=u.core.swarmId.substring(p+f.length);a=new x({p2p:u});a.loadSource(e.src);a.attachMedia(e);l=a.p2pEngine;s(l)}else{r.p2pConfig={logLevel:"error",showSlogan:false,live:h.options.live,appId:h.options.p2pAppId||""};if(r.debug)r.p2pConfig.logLevel="debug";r.p2pConfig=$.extend(r.p2pConfig,h.options.p2pConfig||{});a=new Hls(r);l=a.p2pEngine||a.engine;if(!l&&P2PEngine&&P2PEngine.isSupported()){l=new P2PEngine(a,r.p2pConfig)}a.loadSource(e.src);a.attachMedia(e);l.on("peerId",function(e){$(h.elemPrefix()+".load").text("加载0MB 共享0MB 加速0MB");$(h.elemPrefix()+".peer").text("P2P已开启");$(h.elemPrefix()+".line").text("在线1NP")});l.on("peers",function(e){$(h.elemPrefix()+".line").text("在线"+(e.length+1)+"NP");$(h.elemPrefix()+".peer").text("P2P已开启")});l.on("stats",function(e){$(h.elemPrefix()+".load").text("加载"+(e.totalHTTPDownloaded/1024).toFixed(2)+"MB 共享"+(e.totalP2PUploaded/1024).toFixed(2)+"MB 加速"+(e.totalP2PDownloaded/1024).toFixed(2)+"MB");e.totalP2PDownloaded?$(h.elemPrefix()+".peer").text("P2P加速中"):$(h.elemPrefix()+".peer").text("P2P已开启")})}var d=$(e).children("source");if(d.length>0){d.attr("src",i)}else{var c=document.createElement("source");c.src=i;$(e).append($(c))}if(h.options.disableRemotePlayback===false)e.disableRemotePlayback=false;var m,g,v;a.on(Hls.Events.ERROR,function(e,t){var n="";switch(t.type){case"mediaError":n="媒体错误";var o=h.options.autoRecoverMediaError||false;if(o&&t.fatal){var r=(new Date).getTime();if(!m||r-m>3e3){m=r;a.recoverMediaError();return}if(!g||r-g>3e3){g=r;a.swapAudioCodec();a.recoverMediaError();return}}break;case"networkError":n="网络错误";var o=h.options.autoRecoverNetworkError||false;if(o&&t.fatal){var r=(new Date).getTime();if(!v||r-v>3e3){v=r;a.startLoad();return}}break;default:n=t.type}n+=": ";switch(t.details){case"bufferFullError":case"bufferSeekOverHole":case"bufferNudgeOnStall":case"fragLoadError":if(!t.fatal)return;n+=t.details;break;case"manifestLoadError":n+="媒体加载失败";break;case"manifestLoadTimeOut":n+="媒体加载超时";break;default:n+=t.details}t.message=n;console.error(n);$(h.elemPrefix()+"#video").trigger("error",t)});n.data("hls",a);var o=t.on("destroy",function(){if(a){a.destroy();if(h.options.debug)console.debug("hls destory.");a=null}if(l){if(typeof l.destroy=="function"){l.destroy();if(h.options.debug)console.debug("p2p engine destory.")}l=null}$(h.elemPrefix()+"#video").data("hls",null)});n.data("eventIndex",o);return a},shakaDash:function(e,t){var n=e.src;var o=new shaka.Player(e);o.load(n)}},getType:function(e){var t="auto",e=String(e).split("#")[0].split("?")[0],n=e.lastIndexOf("."),o=n>-1?e.substring(n).toLowerCase():h.options.defaultExtName;if(e.substring(0,7).toLowerCase()=="magnet:"||o==".torrent"){t="customWebTorrent"}else if(o==".m3u8"){t="customHls"}else if(o==".mpd"){t="dash"}else if(o==".flv"){t="flv"}else if(o==".mp4"||o==".mp3"||o==".webm"||o==".ogg"||o==".mkv"){t="normal"}else if(h.options.defaultType){t=h.options.defaultType}return t},eplayer:function(e){var t=$.extend(h.options,e||{});var n=h.player.getType(t.urls);var o=a();var r={container:o,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],contextmenu:t.contextmenu,customSettings:t.customSettings||[],video:{url:t.urls,type:n,pic:t.pics,customType:h.player.customType},touchVideoChangeProgress:t.touchVideoChangeProgress,pluginOptions:{}};if("subtitle"in t&&t.subtitle)r.subtitle=t.subtitle;if("danmaku"in t&&t.danmaku)r.danmaku=t.danmaku;switch(n){case"flv":r.pluginOptions.flv={config:{isLive:t.live,autoCleanupSourceBuffer:true,autoCleanupMinBackwardDuration:60}};break;case"hls":r.pluginOptions.hls={enableWorker:true,liveBackBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,maxBufferSize:0,maxBufferLength:10,liveSyncDurationCount:1};break}r.pluginOptions=$.extend(r.pluginOptions,t.pluginOptions||{});var i=new DPlayer(r);l(i);$(h.elemPrefix()+"#video").data("player",i);return i},dplayer:function(e){var t=$.extend(h.options,e||{});var n=a();var o=new DPlayer({container:n,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:t.screenshot,airplay:t.airplay,chromecast:t.chromecast&&window.chrome&&window.chrome.cast,p2pAppId:t.p2pAppId,highlight:t.highlight||[],touchVideoChangeProgress:t.touchVideoChangeProgress,contextmenu:t.contextmenu,video:{url:t.urls,pic:t.pics}});l(o);$(h.elemPrefix()+"#video").data("player",o);return o}},cookie:{data:{},set:function(e,t,n,o){var r=new Date;if(!n)n=30;r.setTime(r.getTime()+n*24*60*60*1e3);var i=e+"="+escape(t)+";path="+(o?o:s.location.pathname)+";expires="+r.toUTCString()+";sameSite=Lax";if(h.secure)i+=";secure=true";document.cookie=i;h.cookie.data[e]=t},get:function(e){if(typeof h.cookie.data[e]!="undefined")return h.cookie.data[e];var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));if(t!=null)return unescape(t[2])},remove:function(e){h.cookie.set(e,"",-10)}},localStorage:{data:{},set:function(e,t,n,o){if(t===undefined){return h.localStorage.remove(e)}s.localStorage.setItem(e,t);h.localStorage.data[e]=t},get:function(e){if(typeof h.localStorage.data[e]!="undefined")return h.localStorage.data[e];return s.localStorage.getItem(e)},remove:function(e){s.localStorage.removeItem(e)}},store:{set:function(e,t,n,o){return r().set(e,t,n,o)},get:function(e){return r().get(e)},remove:function(e){return r().remove(e)}},jump:function(e){if(!e)return;if($.isFunction(e)){return e()}top.location.href=e}};var t=null;function e(){if(t!==null){return t}try{t="localStorage"in s}catch(e){t=false}return t}function a(){var e=h.elemPrefix(true);var t=e?$(e).find("#video"):null;if(!t||t.length<1)t=document.getElementById("video");else if(t.length>0)t=t[0];return t}function r(){if(e())return h.localStorage;return h.cookie}function n(e,t,n){if(!h.options.listeners)return;if(typeof h.options.listeners[e]!="function")return;h.options.listeners[e].call(t,n)}function l(t){t.on("loadstart",function(){var e=$(t.video);e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");if(h.options.disableRemotePlayback===false)e.removeAttr("disableremoteplayback");if(t.video.paused&&!e.hasClass("dplayer-mobile"))$(h.elemPrefix()+".amplayer-center-button").show();n("loadstart",this,arguments)});t.on("loadeddata",function(){o(h.options,t);n("loadeddata",this,arguments)});t.on("timeupdate",function(){i(h.options,t,t.video.currentTime);n("timeupdate",this,arguments)});t.on("ended",function(){n("ended",this,arguments);h.jump(h.options.jump)});t.on("pause",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(h.elemPrefix()+".amplayer-center-button").show();n("pause",this,arguments)});t.on("play",function(){var e=$(t.video);if(!e.hasClass("dplayer-mobile"))$(h.elemPrefix()+".amplayer-center-button").hide();n("play",this,arguments)});t.on("error",function(){n("error",this,arguments)});$(h.elemPrefix()+".amplayer-play").off("click").on("click",function(){t.play()});$(h.elemPrefix()+".amplayer-backward").off("click").on("click",function(){let e=Math.max(t.video.currentTime-10,0);t.seek(e);t.controller.setAutoHide()});$(h.elemPrefix()+".amplayer-forward").off("click").on("click",function(){let e=Math.min(t.video.currentTime+10,t.video.duration);t.seek(e);t.controller.setAutoHide()})}function u(e,t){return e.toFixed(0)==t.toFixed(0)}function o(e,t){if(e.live)return;if(e.autoSkip&&e.seek<=0&&e.filmRange&&e.filmRange.playRange.min>0){e.seek=e.filmRange.playRange.min}var n=e.take?h.store.get(e.take):0;var o=t.video.currentTime;if(!n){if(u(o,e.seek))return;return t.seek(e.seek)}if(t.video.duration-n<60||e.seek>n){if(u(o,e.seek))return;t.seek(e.seek)}else{if(u(o,n))return;t.seek(n)}}function i(e,t,n){if(e.trys>0&&n>e.trys){$(t.video).trigger("endoftrial",e,t,n);t.notice("试看结束");return t.pause()}if(e.live)return;if(e.take)h.store.set(e.take,n,30);if(e.filmRange&&(e.autoSkip||e.autoSkipAd)){var o=e.filmRange;if(e.autoSkip){if(o.playRange.min>0&&n<o.playRange.min){if(u(n,o.playRange.min))return;return t.seek(o.playRange.min)}var r=o.playRange.max;if(r<0&&r*-1<t.video.duration)r=t.video.duration+r;if(r>0&&n>=r){return h.jump(e.jump)}}if(e.autoSkipAd&&o.skipRange){for(var i=0;o.skipRange.length;i++){var a=o.skipRange[i];if(n>=a.min){if(a.max<0&&a.max*-1<t.video.duration)a.max=t.video.duration+a.max;if(n<a.max){if(u(n,a.max))return;return t.seek(a.max)}}}}}}s.amplayer=h})(window);