(function(p){var c={options:{autoPlay:true,autoSkip:true,autoNext:true,debug:false,live:false,trys:0,seek:0,take:"",urls:"",seq:"",jump:"",logo:"",pics:"",p2pAppId:"",p2pEngine:"",p2pConfig:{},srt2vttConvertApi:"",container:"",defaultType:"customHls",defaultExtName:".m3u8",listeners:{}},secure:p.location.protocol=="https:",elemPrefix:function(){return c.options.container?c.options.container+" ":""},player:{torrentAdd:function(e,t,n){n.notice(App.i18n.CONNECTED,5e3);var r=new RegExp("\\.(mp4)$","i");var o=e.files.find(function(e){console.log("[torrent] adding file: ",e.path||e.name);return r.test(e.name)});var i={autoplay:n.options.autoplay};if(e.urlList&&e.urlList.length>0){var a=new RegExp("poster\\.(jp[e]?g|png|gif|webp|svg)$","i");var l=e.files.find(function(e){return a.test(e.name)});if(l){l=e.urlList[0]+l.path;console.log("[torrent] adding cover: ",l);$(c.elemPrefix()+"video").attr("poster",l)}var p=new RegExp("\\.(vtt)$","i");var s=e.files.find(function(e){return p.test(e.name)});var u="webvtt",f="";if(!s){if(c.options.srt2vttConvertApi){var d=new RegExp("\\.(srt)$","i");s=e.files.find(function(e){return d.test(e.name)});if(s){f=e.urlList[0]+s.path;f=c.options.srt2vttConvertApi+encodeURIComponent(f)}}}else{f=e.urlList[0]+s.path}if(f){console.log("[torrent] adding subtitle: ",f);n.options.subtitle={type:u,url:f,fontSize:"25px",bottom:"10%",color:"#b7daff"};n.initSubtitle(n.options.subtitle)}}if(!o){n.notice(App.i18n.PLAY_FAILED+": "+App.i18n.NOT_FOUND_MEDIA,5e3);return}n.notice(App.i18n.READY_PLAY,5e4);o.renderTo(t,i,function(){n.container.classList.remove("dplayer-loading")})},customType:{customWebTorrent:function(t,r){r.container.classList.add("dplayer-loading");var e=new WebTorrent;var n=t.src;t.torrentId=n;t.src="";t.preload="metadata";t.addEventListener("durationchange",function(){r.container.classList.remove("dplayer-loading")},{once:true});r.notice(App.i18n.CONNECTING,5e3);var o=p.setInterval(function(){if($(c.elemPrefix()+".dplayer-notice").text()=="视频加载失败"){r.notice(App.i18n.CONNECTING,5e3);p.clearInterval(o)}},50);var i=null;var a=function(){if(o){clearInterval(o);o=null}};var l=function(){if(i){clearInterval(i);i=null}};e.add(n,function(n){console.log("[torrent] Client is downloading:",n.infoHash);c.player.torrentAdd(n,t,r);var e=function(){a();var e=Math.round(n.progress*100*100)/100;$(c.elemPrefix()+".line").html('速度 <span class="fa fa-long-arrow-down text-success"></span>'+App.formatBytes(n.downloadSpeed)+' <span class="fa fa-long-arrow-up text-danger"></span>'+App.formatBytes(n.uploadSpeed)+" 在线"+n.numPeers+"NP");$(c.elemPrefix()+".peer").text("BT已开启");var t="已加载"+e+"%";if(n.downloaded){t+=" ("+App.formatBytes(n.downloaded)+")"}if(n.length){t+=" 共"+App.formatBytes(n.length)}$(c.elemPrefix()+".load").text(t)};i=setInterval(e,5e3);e();n.on("wire",function(e,t){console.log("connected to peer with address "+t);a()});n.on("noPeers",function(e){console.log("no peers")});n.on("error",function(){a()});n.on("done",function(){l();a()})});$(c.elemPrefix()+"#video").data("webTorrent",e);r.on("destroy",function(){l();a();if(e){if(e.get(n))e.remove(n);e.destroy();e=null}$(c.elemPrefix()+"#video").data("webTorrent",null)});return e},customHls:function(e,t){var n=$(c.elemPrefix()+"#video");if(n.data("hls")){var r=n.data("eventIndex");t.trigger("destroy");if(r!==null)t.off("destroy",r)}var o=$.extend({debug:c.options.debug,enableWorker:true,liveBackBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,maxBufferSize:0,maxBufferLength:10,liveSyncDurationCount:1},t.options.pluginOptions.hls||{});var i=null;if(c.options.p2pEngine=="p2p-media-loader"){if(p2pml.hlsjs.Engine.isSupported()){i=new p2pml.hlsjs.Engine;o.liveSyncDurationCount=7;o.loader=i.createLoaderClass()}else{c.options.p2pEngine=""}}else{o.p2pConfig={logLevel:"error",live:c.options.live,appId:c.options.p2pAppId||""};if(o.debug)o.p2pConfig.logLevel="debug";o.p2pConfig=$.extend(o.p2pConfig,c.options.p2pConfig||{})}var a=new Hls(o);if(i){p2pml.hlsjs.initHlsJsPlayer(a)}else{i=a.p2pEngine||a.engine;if(!i&&P2PEngine&&P2PEngine.isSupported()){i=new P2PEngine(a,o.p2pConfig)}}a.loadSource(e.src);a.attachMedia(e);if(i){if(c.options.p2pEngine=="p2p-media-loader"){var l=0;i.on(p2pml.core.Events.PeerConnect,function(e){l++;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on(p2pml.core.Events.PeerClose,function(e){l--;if(l<=0)l=0;$(c.elemPrefix()+".line").text("在线"+(l+1)+"NP")});var p={http:0,p2p:0},s={http:0,p2p:0};i.on(p2pml.core.Events.PieceBytesDownloaded,function(e,t,n){p[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(p.http/1024).toFixed(2)+"MB 共享"+(s.p2p/1024).toFixed(2)+"MB 加速"+(p.p2p/1024).toFixed(2)+"MB");p.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")});i.on(p2pml.core.Events.PieceBytesUploaded,function(e,t){s[e]+=t/1024;$(c.elemPrefix()+".load").text("加载"+(p.http/1024).toFixed(2)+"MB 共享"+(s.p2p/1024).toFixed(2)+"MB 加速"+(p.p2p/1024).toFixed(2)+"MB");p.p2p>0?$(".peer").text("P2P加速中"):$(".peer").text("P2P已开启")})}else{i.on("peerId",function(e){$(c.elemPrefix()+".load").text("加载0MB 共享0MB 加速0MB");$(c.elemPrefix()+".peer").text("P2P已开启");$(c.elemPrefix()+".line").text("在线1NP")});i.on("peers",function(e){$(c.elemPrefix()+".line").text("在线"+(e.length+1)+"NP");$(c.elemPrefix()+".peer").text("P2P已开启")});i.on("stats",function(e){$(c.elemPrefix()+".load").text("加载"+(e.totalHTTPDownloaded/1024).toFixed(2)+"MB 共享"+(e.totalP2PUploaded/1024).toFixed(2)+"MB 加速"+(e.totalP2PDownloaded/1024).toFixed(2)+"MB");e.totalP2PDownloaded?$(c.elemPrefix()+".peer").text("P2P加速中"):$(c.elemPrefix()+".peer").text("P2P已开启")})}}var u,f,d;a.on(Hls.Events.ERROR,function(e,t){var n="";switch(t.type){case"mediaError":n="媒体错误";var r=c.options.autoRecoverMediaError||false;if(r&&t.fatal){var o=(new Date).getTime();if(!u||o-u>3e3){u=o;a.recoverMediaError();return}if(!f||o-f>3e3){f=o;a.swapAudioCodec();a.recoverMediaError();return}}break;case"networkError":n="网络错误";var r=c.options.autoRecoverNetworkError||false;if(r&&t.fatal){var o=(new Date).getTime();if(!d||o-d>3e3){d=o;a.startLoad();return}}break;default:n=t.type}n+=": ";switch(t.details){case"bufferFullError":case"bufferSeekOverHole":case"bufferNudgeOnStall":case"fragLoadError":if(!t.fatal)return;n+=t.details;break;case"manifestLoadError":n+="媒体加载失败";break;case"manifestLoadTimeOut":n+="媒体加载超时";break;default:n+=t.details}t.message=n;console.error(n);$(c.elemPrefix()+"#video").trigger("error",t)});n.data("hls",a);var r=t.on("destroy",function(){if(a){a.destroy();a=null}$(c.elemPrefix()+"#video").data("hls",null)});n.data("eventIndex",r);return a},shakaDash:function(e,t){var n=e.src;var r=new shaka.Player(e);r.load(n)}},getType:function(e){var t="auto",e=String(e).split("#")[0].split("?")[0],n=e.lastIndexOf("."),r=n>-1?e.substring(n).toLowerCase():c.options.defaultExtName;if(e.substring(0,7).toLowerCase()=="magnet:"||r==".torrent"){t="customWebTorrent"}else if(r==".m3u8"){t="customHls"}else if(r==".mpd"){t="dash"}else if(r==".flv"){t="flv"}else if(c.options.defaultType){t=c.options.defaultType}return t},eplayer:function(e){var t=$.extend(c.options,e||{});var n=c.player.getType(t.urls);var r=c.elemPrefix();var o=r?$(r).find("video"):null;if(!o||o.length<1)o=document.getElementById("video");var i={container:o,autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:true,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,type:n,pic:t.pics,customType:c.player.customType},pluginOptions:{}};switch(n){case"flv":i.pluginOptions.flv={config:{isLive:t.live,autoCleanupSourceBuffer:true,autoCleanupMinBackwardDuration:60}};break;case"hls":i.pluginOptions.hls={enableWorker:true,liveBackBufferLength:15,backBufferLength:15,liveMaxBackBufferLength:15,maxBufferSize:0,maxBufferLength:10,liveSyncDurationCount:1};break}i.pluginOptions=$.extend(i.pluginOptions,t.pluginOptions||{});var a=new DPlayer(i);l(a);$(c.elemPrefix()+"#video").data("player",a);return a},dplayer:function(e){var t=$.extend(c.options,e||{});var n=new DPlayer({container:document.getElementById("video"),autoplay:t.autoPlay,live:t.live,logo:t.logo,screenshot:true,p2pAppId:t.p2pAppId,highlight:t.highlight||[],video:{url:t.urls,pic:t.pics}});l(n);$(c.elemPrefix()+"#video").data("player",n);return n}},cookie:{data:{},set:function(e,t,n){var r=new Date;r.setTime(r.getTime()+n*24*60*60*1e3);var o=e+"="+escape(t)+";path="+p.location.pathname+";expires="+r.toUTCString()+";sameSite=Lax";if(c.secure)o+=";secure=true";document.cookie=o;c.cookie.data[e]=t},get:function(e){if(typeof c.cookie.data[e]!="undefined")return c.cookie.data[e];var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));if(t!=null)return unescape(t[2])},remove:function(e){c.cookie.set(e,"",-10)}},localStorage:{data:{},set:function(e,t,n){if(t===undefined){return c.localStorage.remove(e)}p.localStorage.setItem(e,t);c.localStorage.data[e]=t},get:function(e){if(typeof c.localStorage.data[e]!="undefined")return c.localStorage.data[e];return p.localStorage.getItem(e)},remove:function(e){p.localStorage.removeItem(e)}},store:{set:function(e,t,n){return r().set(e,t,n)},get:function(e){return r().get(e)},remove:function(e){return r().remove(e)}},jump:function(e){if(!e)return;if($.isFunction(e)){return e()}top.location.href=e}};var t=null;function e(){if(t!==null){return t}try{t="localStorage"in p}catch(e){t=false}return t}function r(){if(e())return c.localStorage;return c.cookie}function n(e,t,n){if(!c.options.listeners)return;if(typeof c.options.listeners[e]!="function")return;c.options.listeners[e].call(t,n)}function l(t){t.on("loadstart",function(){var e=$(c.elemPrefix()+"video");e.attr("playsinline","true");e.attr("x5-playsinline","true");e.attr("webkit-playsinline","true");if(t.video.paused)$(c.elemPrefix()+".amplayer-play").show();n("loadstart",this,arguments)});t.on("loadeddata",function(){o(c.options,t);n("loadeddata",this,arguments)});t.on("timeupdate",function(){i(c.options,t,t.video.currentTime);n("timeupdate",this,arguments)});t.on("ended",function(){n("ended",this,arguments);c.jump(c.options.jump)});t.on("pause",function(){$(c.elemPrefix()+".amplayer-play").show();n("pause",this,arguments)});t.on("play",function(){$(c.elemPrefix()+".amplayer-play").hide();n("play",this,arguments)});t.on("error",function(){n("error",this,arguments)});$(c.elemPrefix()+".amplayer-play").click(function(){t.play()})}function o(e,t){if(e.live)return;if(e.autoSkip&&e.seek<=0&&e.filmRange&&e.filmRange.playRange.min>0){e.seek=e.filmRange.playRange.min}var n=e.take?c.store.get(e.take):0;var r=t.video.currentTime;if(!n){if(r==e.seek)return;return t.seek(e.seek)}if(t.video.duration-n<60||e.seek>n){if(r==e.seek)return;t.seek(e.seek)}else{if(r==n)return;t.seek(n)}}function i(e,t,n){if(e.trys>0&&n>e.trys){$(t.video).trigger("endoftrial",e,t,n);t.notice("试看结束");return t.pause()}if(e.live)return;if(e.take)c.store.set(e.take,n,30);if(!e.autoSkip||!e.filmRange)return;var r=e.filmRange;if(r.playRange.min>0&&n<r.playRange.min){return t.seek(r.playRange.min)}var o=r.playRange.max;if(o<0&&o*-1<t.video.duration)o=t.video.duration+o;if(o>0&&n>=o){return c.jump(e.jump)}if(!r.skipRange)return;for(var i=0;r.skipRange.length;i++){var a=r.skipRange[i];if(n>=a.min){if(a.max<0&&a.max*-1<t.video.duration)a.max=t.video.duration+a.max;if(n<a.max){return t.seek(a.max)}}}}p.amplayer=c})(window);