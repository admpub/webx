{{Extend "user/base"}}
{{Block}}
{{/Block}}
{{Block "body"}}
{{Super}}
<div class="main mg-lg-l-240 pd-t-70 pd-lg-t-75">
  <div class="main-header pd-x-20 pd-y-30 bg-white d-sm-flex align-items-center justify-content-between">
    <h5 class="tx-inverse tx-bold mg-b-0">{{"扫码二维码"|$.T}}</h5>
    <nav class="breadcrumb pd-0 bg-transparent mg-b-0 tx-size-12 mg-t-5 mg-sm-t-0">
      <a class="breadcrumb-item" href="{{FrontendURL}}/user/index">{{"用户中心"|$.T}}</a>
      <span class="breadcrumb-item active">{{"扫码二维码"|$.T}}</span>
    </nav>
  </div>

  <div class="main-body pd-20">
<div class="row">
  <div class="col-lg-12 mg-t-0">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title">{{"扫码二维码"|$.T}}</h6>
      </div><!-- card-header -->
      <div class="card-block">
      <style>#qr-reader{border:0 !important;}</style>
      <div id="qr-reader"></div>
      </div>
    </div><!-- card -->
  </div><!-- col-6 -->
  <div class="col-lg-12 mg-t-20">
    <div class="card">
      <div class="card-header">
        <span class="pull-right">
          <a href="javascript:;" class="btn btn-default btn-xs hidden" id="btn-copy-qrcode" data-target-name="{{`扫码结果`|$.T}}" data-clipboard-target="#qr-reader-results">
            <i class="fa fa-copy"></i>
            {{`复制`|$.T}}
          </a>
        </span>
        <h6 class="card-title mg-b-0">{{"扫码结果"|$.T}}</h6>
      </div><!-- card-header -->
      <div>
      <div class="card-block">
        <div id="qr-reader-results" class="card-text"></div>
      </div>
    </div><!-- card -->
  </div>
</div><!-- row -->

    </div><!-- main-body -->
</div><!-- main -->
{{/Block}}

{{Block "footer"}}
{{Super}}
<script src="{{AssetsXURL}}/js/qrcode/html5-qrcode.min.js?t={{BuildTime}}" charset="utf-8"></script>
<script src="{{AssetsURL}}/js/clipboard/clipboard.min.js?t={{BuildTime}}" charset="utf-8"></script>
<script src="{{AssetsURL}}/js/clipboard/utils.js?t={{BuildTime}}" charset="utf-8"></script>
<script>
$(function(){
var resultContainer = document.getElementById('qr-reader-results'),lastDecodedText='',t=null;
function clearTimeoutT(){
  if(!t) return; 
  clearTimeout(t);t=null;
}
function onScanSuccess(decodedText, decodedResult) {
  if(lastDecodedText===decodedText) return;
  lastDecodedText=decodedText;
  clearTimeoutT();
  t=setTimeout(function(){lastDecodedText=''},5000);
  $.post(FRONTEND_URL+'/user/qrcode/scan',{data:decodedText},function(r){
      if(r.Code!=1){
        if(r.Code==-101){
          resultContainer.innerText=decodedText
          if(decodedText){
            $('#btn-copy-qrcode.hidden').removeClass('hidden');
            App.message({text:App.t('识别成功'),type:'success'});
          }else{
            $('#btn-copy-qrcode:not(.hidden)').addClass('hidden')
            clearTimeoutT();
          }
          return;
        }

        resultContainer.innerText=r.Info
        $('#btn-copy-qrcode:not(.hidden)').addClass('hidden')
        lastDecodedText='';
        clearTimeoutT();
        return App.message({text:r.Info,type:'error'});
      }
      resultContainer.innerText=r.Info
      $('#btn-copy-qrcode:not(.hidden)').addClass('hidden')
      return App.message({text:r.Info,type:'success'});
  },'json').error(function(){
    lastDecodedText='';
    clearTimeoutT();
  });
}
function onScanFailure(error) { 
  lastDecodedText='';
}
var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", {fps: 10, qrbox: 250, isShowingInfoIcon: false});
html5QrcodeScanner.render(onScanSuccess,onScanFailure);
attachCopy('#btn-copy-qrcode');
})
</script>
{{/Block}}
